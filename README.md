# Witness Policy Tool

This is a policy checker for [Witness](https://github.com/testifysec/witness) policies. The tool reads in a **unsigned** JSON-encoded policy file and performs various checks to verify that the policy is valid.

## Download

You can download the latest linux x64 release of `policy-tool` from [GitHub](https://github.com/testifysec/policy-tool/releases/download/v0.1.14/policy-tool).

If you need support for other arch/platforms please compile from source


#### Check Command

The tool is run from the command line and takes the unsigned policy file as its only argument. For example:

```policy-tool check unsigned_policy_file.json```

The tool will output the following information:

- The steps in the policy file and the attestations associated with each step
- The decoded Rego policy module for each attestation
- The roots used in the policy file and the subject of each root's certificate
- The number of steps and roots parsed from the policy file

If there are any errors in the policy file, the tool will output a detailed error message with information about the error, including the step and attestation where the error occurred.

#### Create Command

`create` - Creates a policy file.

#### Flags

- `-s, --step` - Step name to bind subsequent flags to (e.g., root CA, intermediate, attestations, Rego policy)
- `-t, --tsa-ca` - Path to the x.509 PEM encoded CA file or URL; should be used after a step flag
- `-r, --root-ca` - Path to the x.509 PEM encoded CA or URL; should be used after a step flag
- `-i, --intermediate` - Path to the intermediate PEM file (optional); should be used after a step flag
- `-a, --attestations` - Attestations to include in the policy for a step; should be used after a step flag
- `-k, --key` - Path to a PEM encoded x.509 public key file or URL to associate with an attestation; should be used after a step flag
- `-g, --rego` - Path to a Rego policy file to associate with an attestation; should be used after an attestation flag
- `--constraint-commonname` - Certificate common name constraint
- `--constraint-dnsnames` - Certificate DNS names constraint (comma-separated)
- `--constraint-emails` - Certificate emails constraint (comma-separated)
- `--constraint-organizations` - Certificate organizations constraint (comma-separated)
- `--constraint-uris` - Certificate URIs constraint (comma-separated)

#### Examples


## Examples

### Simple example

```bash
create --step test -r /path/to/root.pem --attestations https://witness.dev/attestations/commandrun/v0.1
```

This command creates a policy file with a root certificate located at `/path/to/root.pem` and an acommandRun attestation. The policy file will contain a single step named `test`.

### Complex example

```bash
policy-tool create \
                   ##Step1 \
                   -s step1 \
                   -r /path/to/root.pem \
                   -i /path/to/intermediate.pem \
                   -a https://witness.dev/attestations/aws/v0.1 \
                   -g /path/to/rego/file.rego \
                   -a https://witness.dev/attestations/commandrun/v0.1 \
                   -g /path/to/rego/file.rego \
                   ##Step2 \
                   -s step2 \
                   -i /path/to/intermediate.pem \
                   -a https://witness.dev/attestations/aws/v0.1 \
                   -a https://witness.dev/attestations/commandrun/v0.1 \
                   -g /path/to/rego/file.rego
```

This is an example command for using the policy-tool to create a complex Witness policy with multiple steps.

The command starts with policy-tool create, indicating that the create command should be used to generate a new policy. Then, it defines two steps using the -s flag: step1 and step2. For each step, it specifies the intermediate certificate using -i, and the attestations using -a. In step 1, two attestations are specified, along with the path to a Rego policy file (-g) for each attestation. Step 2 also has two attestations, but only one Rego policy file is used for both.

Each line in the command corresponds to a separate flag or parameter for the create command. The use of the backslash character (\) at the end of each line indicates that the command continues onto the next line for readability purposes.

The final policy file generated by this command would contain two steps, with the specified intermediate certificate, attestations, and associated Rego policy files for each step.

## Notes

- The tool requires that the `--root-ca` or `--public-key` and `--attestations` flags are used at least once.
- Flags should be used after a step flag, which binds the flags to a specific step in the policy file. 
- The Rego policy file specified with the `--rego` flag is encoded as a base64 string in the policy file.
